---
title: "An Exploratory Look Aboard the Titanic"
author: "Marshall McQuillen"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = TRUE)
```

## Guiding Question

Which passengers will survive the sinking of the Titanic?

## Secondary Questions

1. What characteristics separate those who survived from those who died?
2. What charactersistics make someone more likely to survive?
3. How do different characteristics of passengers vary with one another?

```{r import_data}
setwd("/Users/marsh/data_science_projects/Kaggle_Competitions/titanic_survival_classification/")
training <- read.csv('/Users/marsh/data_science_projects/Kaggle_Competitions/titanic_survival_classification/titanic_train.csv')
```

```{r install/load_packages}
# install.packages("tidyverse")
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(knitr))
```

## 1 Data Overview

Looking at the training data froma bird-eye view, there are 891 observations representing passengers and 12 variables. Since some of the variable name are a little cryptic, an description for each is provided below.

| Variable Name | Description |
| ----------------------------------------- | ----------------------------------------- |
| PassengerId | Unique identifier for each passenger |
| Survived | Binary; 1 = Survied & 0 = Died |
| Pclass | Socio-economic status; 1 = Upper, 2 = Middle & 3 = Lower |
| Name | Passenger Name |
| Sex | Male or Female |
| Age | Passenger Age |
| SibSp | Number of siblings or spouse aboard ship |
| Parch | Number of parents or children aboard ship |
| Ticket | Ticket Number |
| Fare | Amount paid for ticket |
| Cabin | Cabin number |
| Embarked | The town from which the passenger boarded the ship; C = Cherbourg, Q = Queenstown & S = Southhampton |

First and foremost, by running `str(training)` on the data, it is apparent that the first entries in the Cabin and Embarked columns are empty strings, indicating that the data is probably not perfectly clean (no surprises there). Checking to see where any Null's might be, it becomes clear that there are in fact no nulls, and that these spaces were intentionally left empty. In addition to null values, all the NA's are in the Age, accounting for roughly 20% of the values in that column. Both of these will need to be imputed intelligently when the time to create a predictive model comes around.

In addition to the missing values, it is important to note that some of the discrete attributes have been read in as continous variabes such as Pclass, Sibsp and Parch. Since these variables actually represent discrete characteristics of each passenger, changing them to be non-continuous will allow a more representative analysis.

```{r data_overview}
# str(training)

#Set classes
training$PassengerId <- as.factor(training$PassengerId)
training$Survived <- as.factor(training$Survived)
training$Pclass <- as.factor(training$Pclass)
training$SibSp <- as.factor(training$SibSp)
training$Parch <- as.factor(training$Parch)

# view null count
nulls <- lapply(training[,1:12], is.null)
na <- lapply(training[,1:12], is.na)
null_count <- lapply(nulls, sum)
na_count <- lapply(na, sum)

df <- mapply(data.frame, null_count, na_count)
row.names(df) <- c("Null Count", "NA Count")

df1 <- df[,1:6]
df2 <- df[,7:12]

knitr::kable(df1, caption = "Attribute Null & NA Counts")
knitr::kable(df2, caption = "Attribute Null & NA Counts (continued)")

#Percent of Age variable that is NA
age_percent_na <- paste(round(sum(is.na(training$Age))/length(training$Age)*100, digits = 2), "%", sep = "")
```

## 2 Bayesian Survival

### 2.1 Does Money Sink or Swim?

By creating a table with the Pclass (which refers to the socioeconomic status (SES) of the passenger) and Survived variables, I can get a good sense of the number of passengers that lived and died, based on their SES. Simple summation and division returns the probabilites of a passenger living given their respective SES

```{r pclass_vs_survived}
#Probability of living by socio-economic status
pclass_table <- with(training, table(Survived, Pclass))
upper_class <- pclass_table[2,1]/sum(pclass_table[,1])
middle_class <- pclass_table[2,2]/sum(pclass_table[,2])
lower_class <- pclass_table[2,3]/sum(pclass_table[,3])

row.names(pclass_table) <- c('Died','Survived')
colnames(pclass_table) <- c('Upper','Middle','Lower')
knitr::kable(pclass_table, caption = "Survival Counts by SES")
#Probability of living given Upper Class
upper_sr <- paste(round(upper_class*100, digits = 2), "%", sep = "")

#Probability of living given Middle Class
middle_sr <- paste(round(middle_class*100, digits = 2), "%", sep = "")

#Probability of living given Lower Class
lower_sr <- paste(round(lower_class*100, digits = 2), "%", sep = "")

sr_table <- data.frame(c(upper_sr, middle_sr, lower_sr), row.names = c("Upper Class",'Middle Class','Lower Class'))
colnames(sr_table) <- 'Probability of Living'
knitr::kable(sr_table, caption = "Survival Rates by SES", align = 'r')
```

\pagebreak

This same information is displayed visually below.

\hfill

```{r bayes_part_2}
g <- ggplot(training, aes(y=Survived,  x=factor(Survived,
                                                labels=c("Died","Lived"))))
g <- g + geom_bar(aes(y=..prop.., group=Pclass,
                      fill=factor(..x.., labels=c("Died","Lived"))))
g <- g + facet_grid(~factor(Pclass,
                            labels=c("Upper Class", "Middle Class",
                                     "Lower Class")))
g <- g + scale_y_continuous(labels = scales::percent) 
g <- g + scale_fill_discrete(name="Survival Status")
g <- g + labs(x="", y = "Percentage",
              title = "Probabilities of Living Given Socio-Economic Status")
g <- g + geom_text(
      aes(label = paste(round((..count../c(216,216,184,184,491,491)), 4)*100, "%", sep = ""), y = ..prop..),  stat= "count",
      vjust = c(17.25,10,12.75,14.5,6.5,21))
g
```

#### 2.1.1 Illustrating Bayes Theorem with Survival Rates and Socioeconomic Status

This type of classification problem creates a great opportunity to illustrate Bayes' Theorem. Recall that Bayes Theorem is defined as:

$$P(A|B)~=~\frac{P(B|A)P(A)}{P(B)}$$

where: 

* $P(A|B)$ = Posterior
* $P(B|A)$ = Likelihood
* $P(A)$ = Prior
* $P(B)$ = Normalizing Constant.

The equation above can be rewritten to better match the problem context as:

$$P(~"X~class~citizen"~|~"Lived"~)~=~\frac{P(~"Lived"~|~"X~class~citizen"~)~P(~"X~class~citizen"~)}{P(~"Lived"~)}$$

where:

* $P(~"X~class~citizen"~|~"Lived"~)$ = Posterior
* $P(~"Lived"~|~"X~class~citizen"~)$ = Likelihood
* $P(~"X~class~citizen"~)$ = Prior
* $P(~"Lived"~)$ = Normalizing Constant.

$P(~"Lived"~)$, the Normalizing Constant, will be the probability of living, *regardless of SES.* This could be broken out into three terms,

$$P(~"Lived"~|~"Upper~class~citizen"~)~+~P(~"Lived"~|~"Middle~class~citizen"~)~+~P(~"Lived"~|~"Lower~class~citizen"~)$$

however it is far easier to calculate the proportion of those that lived over everyone that was aboard the ship. This comes out to be 38.38%.

The final term needed to complete the right hand side of the equation, the Prior, is simply the proportion of those on board that were Upper, Middle or Lower class. These come out to be 24.24%, 20.65% and 55.11%, respectively, shown in the table below.

```{r bayes_part_3}
total <- nrow(training)
total_died <- nrow(subset(training, Survived == 0))
total_lived <- nrow(subset(training, Survived == 1))

prob_lived <- total_lived / total

upper_prob <- as.numeric(table(training$Pclass)[1])/nrow(training)
middle_prob <- as.numeric(table(training$Pclass)[2])/nrow(training)
lower_prob <- as.numeric(table(training$Pclass)[3])/nrow(training)

upper_prob_str <- paste(round(upper_prob*100, digits = 2), "%", sep = "")
middle_prob_str <- paste(round(middle_prob*100, digits = 2), "%", sep = "")
lower_prob_str <- paste(round(lower_prob*100, digits = 2), "%", sep = "")

ses_df <- data.frame(c(upper_prob_str, middle_prob_str, lower_prob_str), row.names = c("Upper Class",'Middle Class','Lower Class'))
colnames(ses_df) <- "Probability of Being X Class"
knitr::kable(ses_df, caption = "Socioeconomic Status Proportions Aboard the Titanic", align = 'r')
```

Now it is simply a matter of defining three different equations for each of the three possible socioeconomic status', and substituting in the corresponding numbers (Note that in the above percentages I rounded to two decimal places, however when calculating the final probability it is paramount that the entire number is used).

$$P(~"Upper~class~citizen"~|~"Lived"~)~=~\frac{0.6296296\cdot0.2424242
}{0.3838384}~=~0.3976608~=~39.77\%$$

$$P(~"Middle~class~citizen"~|~"Lived"~)~=~\frac{0.4728261\cdot0.2065095}{0.3838384}~=~0.254386~=~25.44\%$$

$$P(~"Lower~class~citizen"~|~"Lived"~)~=~\frac{0.2423625\cdot0.5510662}{0.3838384}~=~0.3479532~=~34.8\%$$

```{r bayes_part_4}
#Probability of being an Upper class citizen given a passenger lived
prob_upper_given_lived <- (upper_class*upper_prob)/prob_lived

#Probability of being a Middle class citizen given a passenger lived
prob_middle_given_lived <- (middle_class*middle_prob)/prob_lived

#Probability of being a Lower class ctizen given a passenger lived
prob_lower_given_lived <- (lower_class*lower_prob)/prob_lived
```

\pagebreak

This can be double checked visually by dividing the passengers into those that lived and died, and then, for each of those groups, plotting the percentage that were Upper, Middle and Lower class. Low and behold, Bayes is right.

\hfill

```{r}
f <- ggplot(training, aes(y = Pclass,
                          x = factor(Pclass,labels=c("Upper","Middle","Lower"))))
f <- f + geom_bar(aes(y=..prop.., group=Survived,
                      fill = factor(..x.., labels=c("Upper Class","Middle Class","Lower Class"))))
f <- f + facet_grid(~factor(Survived, labels = c("Died","Lived")))
f <- f + scale_y_continuous(labels = scales::percent)
f <- f + scale_fill_discrete(name = "Socio-Economic Status")
f <- f + labs(x = "", y = "Percentage", title = "Probabilities of Socio-Economic Status Given Lived or Died")
f <- f + geom_text(
      aes(label = paste(round((..count../c(549,549,549,342,342,342)), 4)*100, "%", sep = ""), y = ..prop..), stat= "count",
      vjust = c(24,23,9,16.75,20.75,18.25))
f

```

Using the same code as above, with a few minor adjustments I can make similar graphs with other qualitative variables, such as the sex of the passenger.

```{r sex/survived}
#Sex vs. Survived
a <- ggplot(training, aes(y=Survived,  x=factor(Survived,
                                                labels=c("Died","Lived"))))
a <- a + geom_bar(aes(y=..prop.., group=Sex,
                      fill=factor(..x.., labels=c("Died","Lived"))))
a <- a + facet_grid(~factor(Sex,
                            labels=c("Female", "Male")))
a <- a + scale_y_continuous(labels = scales::percent) 
a <- a + scale_fill_discrete(name="Survival Status")
a <- a + labs(x="", y = "Percentage",
              title = "Probabilities of Living Given Gender")
a <- a + geom_text(
      aes(label = paste(round((..count../c(314,314,577,577)), 4)*100, "%", sep = ""), y = ..prop..),  stat= "count",
      vjust = c(20.5,7,5,22.5))
a
```

## 3 Cabin Classification

It seems logical that looking at *where* each passenger was when the Titanic started sinking could provide some insight as to why some lived and others did not. The "Sinking" section on the [Titanic Wikipedia Page](https://en.wikipedia.org/wiki/RMS_Titanic) states that the iceberg was struck at 11:40 pm. Considering the time of night, combined with the likely cold air temperature, I think it is safe to say that most passengers were inside, if not in their rooms sleeping.

Finding out where each passenger was will be a two fold process:

1. Subsetting on the Deck they were on, noted by the letter in the Cabin column.
2. Subsetting where on that deck they were, noted by the number in the Cabin column.

An important note is that the vast majority of the passengers did not have an entry in the Cabin column. (There aren't any NA's, the entries are not even filled with spaces, they are simply "nothing"). In order to subset these observations, I used the ouput from a "nothing" observation in the logical statement.

After subsetting, summing the number of rows in each subset, *which should equal 891, the total number of observations,* returns 894. A little searching led to finding the duplicates, show below.


```{r}
#Split data on Cabin Letter
a_class <- training[grep("A", training$Cabin),]
b_class <- training[grep("B", training$Cabin),]
c_class <- training[grep("C", training$Cabin),]
d_class <- training[grep("D", training$Cabin),]
e_class <- training[grep("E", training$Cabin),]
f_class <- training[grep("F", training$Cabin),]
g_class <- training[grep("G", training$Cabin),]

#the "nothing" class
blank_class <- subset(training, Cabin == training[1,11])

sum(nrow(a_class) + nrow(b_class) + nrow(c_class) + nrow(d_class) +
          nrow(e_class) + nrow(f_class) + nrow(g_class) + nrow(blank_class))

#Duplicate Cabin Values
duplicates <- training[c(76,129,700,716),]
duplicates

#look at passenger id 534
training[grep("Peter", training$Name),]
```

To decide which subset to assign these observations too, looking at the Embarked and Ticket columns for those observations in the g_class subset, I can see that everyone in this cabin class embarked from Southampton and had similar ticket


```{r}
table(a_class$Survived)[2]/sum(table(a_class$Survived))
table(b_class$Survived)[2]/sum(table(b_class$Survived))
table(c_class$Survived)[2]/sum(table(c_class$Survived))
table(d_class$Survived)[2]/sum(table(d_class$Survived))
table(e_class$Survived)[2]/sum(table(e_class$Survived))
table(f_class$Survived)[2]/sum(table(f_class$Survived))
table(g_class$Survived)[2]/sum(table(g_class$Survived))
table(blank_class$Survived)[2]/sum(table(blank_class$Survived))

#Split data on Cabin Room Number
tCabin_number = grep("[0-9]{2,}", training$Cabin)
test <- mutate(training, test_column = c(strsplit(as.character(training$Cabin), " ")))

#Parch and Sibsp Analysis
table(training$Parch, training$Survived)

h <- ggplot(data = training,
            aes(y = Survived,
                x = factor(Survived, labels = c("Died","Lived"))))
h <- h + geom_bar(aes(y = ..prop.., group = Parch,
                      fill = factor(..x.., labels = c("Died","Lived"))))
h <- h + facet_grid(~Parch)
h <- h + scale_y_continuous(labels = scales::percent)
h <- h + scale_fill_discrete()
h

d <- ggplot(data = training,
            aes(y = Survived,
                x = factor(Survived, labels = c("Died","Lived"))))
d <- d + geom_bar(aes(y = ..prop.., group = SibSp,
                      fill = factor(..x.., labels = c("Died","Lived"))))
d <- d + facet_grid(~SibSp)
d <- d + scale_y_continuous(labels = scales::percent)
d <- d + scale_fill_discrete()
d

```



